Что делает программа

Программа позволяет упростить и ускорить заполнение таблиц «Дома 202х», уменьшив нагрузку на сотрудников, при этом оставаясь надёжной в плане точности нахождения названий УК, их ИНН и контактных данных. Программа заполняет не все адреса, но большую их часть (на момент последней версии, программе не удалось заполнить только 1969 адресов из 32648). Не заполняются адреса по причине: отсутствия их в базе ГИС; наличия адреса в ГИС, но отсутствия в базе данных об УК; сложностях в прочтении адреса. Рекомендуется проверять пропущенные адреса вручную.


1. Импорт библиотек
   
import os, re, sys, logging

from collections import defaultdict, Counter

import pandas as pd

import glob

•	os — работа с файловой системой (папки, файлы).

•	re — работа с регулярными выражениями (поиск и замена текста по шаблонам).

•	sys — взаимодействие с системными командами (например, завершение программы).

•	logging — ведение журнала действий программы.

•	collections — удобные структуры данных: defaultdict для словарей со значениями по умолчанию, Counter для подсчета.

•	pandas — основная библиотека для работы с таблицами Excel/CSV.

•	glob — поиск файлов по шаблону.


2. Настройки путей и файлов
   
CURRENT_DIR = os.getcwd()

OUTPUT_DIR = os.path.join(CURRENT_DIR, "Обработанные файлы")

os.makedirs(OUTPUT_DIR, exist_ok=True)

•	CURRENT_DIR — текущая папка, где находится программа.

•	OUTPUT_DIR — папка для сохранения обработанных файлов.

•	os.makedirs(..., exist_ok=True) — создаёт папку, если она ещё не существует.

INPUT_XLSX = (glob.glob(os.path.join(CURRENT_DIR, "Дома*.xlsx")) or [None])[0]

INN_XLSX = (glob.glob(os.path.join(CURRENT_DIR, "Реестр поставщиков информации*.xlsx")) or [None])[0]

•	Находит входной файл с адресами домов (по шаблону "Дома*.xlsx") и файл с ИНН организаций.

•	Если файла нет, программа выводит сообщение и завершает работу (sys.exit(1)).

OUTPUT_XLSX = os.path.join(OUTPUT_DIR, "result.xlsx")

MISSED_CSV = os.path.join(OUTPUT_DIR, "missed.csv")

CHUNK_SIZE = 200_000

PROGRESS_EVERY = 500

•	OUTPUT_XLSX — файл, куда сохраняется результат.

•	MISSED_CSV — файл с адресами, для которых не удалось найти УК или ИНН.

•	CHUNK_SIZE — размер блока данных при чтении больших CSV-файлов.

•	PROGRESS_EVERY — через сколько строк выводить прогресс обработки.


3. Логирование
   
logging.basicConfig(

    level=logging.INFO,
    
    format="%(asctime)s | %(levelname)s | %(message)s",
    
    stream=sys.stdout,
    
)

logger = logging.getLogger(__name__)

•	Настраивает вывод сообщений о работе программы (информация, предупреждения, ошибки).


4. Регулярные выражения и словари для обработки адресов
 
•	REPLACEMENTS — список сокращений и их полные формы: "ул." → "улица", "пр-д" → "проезд", "мкр" → "микрорайон".

•	SERVICE_WORDS — слова, которые не влияют на точность поиска адреса (например: "россия", "область", "г").

•	CITY_REMOVE — для удаления слова "Москва".

•	ADDR_LABELS — слова для обозначения домов, участков ("д.", "дом", "владение").

•	HOUSE_TOKEN_RE и HOUSE_KEYWORDS — шаблоны для распознавания номера дома, корпуса или строения.


5. Вспомогательные функции
    
Очистка полей

def clean_field(x):

    if x is None or pd.isna(x) or str(x).lower() == 'nan':
    
        return ''
        
    return str(x).strip()
    
•	Преобразует пустые значения или NaN в пустую строку.

Очистка ИНН от возможных нецифровых значений

def inn_digits_only(v):

    return re.sub(r'\D', '', str(v) if v else '')
    
•	Оставляет только цифры, удаляет пробелы и знаки.

6. Нормализация адресов
    
Разделение номера и корпуса

def split_attached_numbers(s: str) -> str:

    ...
    
•	Добавляет пробел между номером дома и словами "корпус", "строение", "литера".

Нормализация адреса

def normalize_address(addr: str) -> str:

    ...
    
•	Приводит адрес к нижнему регистру, заменяет сокращения, убирает лишние слова и знаки.

•	Результат: единообразный, чистый адрес.

Извлечение улицы и дома

def extract_house_and_street_tokens(norm: str):

    ...
    
•	Разделяет нормализованный адрес на два компонента: улица и дом.

•	Возвращает set улицы (для удобного сравнения) и строку с домом.

Создание ключа

def make_key(norm: str) -> str:

    street_set, house = extract_house_and_street_tokens(norm)

    street_part = ' '.join(sorted(street_set))
    
    return f"{street_part} {house}".strip() if house else street_part
    
•	Генерирует уникальный ключ для адреса, который используется для поиска УК.


7. Нормализация названий организаций
 
def org_norm(s: str) -> str:

    ...
    
•	Приводит название УК к единому виду: нижний регистр, убирает кавычки, юридические формы ("ООО", "АО").

def org_tokens(s: str) -> set:

    ...
    
•	Делит название на отдельные слова для удобного поиска и сравнения.


8. Работа с CSV и построение индекса адресов
    
def build_addr_dict_from_csv():

    ...
    
•	Находит все CSV-файлы в папке.

•	Читает их блоками (CHUNK_SIZE).

•	Для каждой строки извлекает адрес и название УК.

•	Строит два словаря:

    1.	addr_dict — ключ адреса → (название УК, ОГРН)
    
    2.	house_index — номер дома → список кандидатов (для поиска по дому, если идеального совпадения нет)
    

8. Построение индекса ИНН
   
def build_inn_lookup():

    ...
    
•	Читает файл с ИНН 

•	Находит колонки с полным и коротким названием, ИНН, ОГРН, телефоном, e-mail, сайтом.

•	Строит несколько словарей для поиска:

    o	exact_index — точное совпадение названия.
    
    o	clean_index — нормализованное название.
    
    o	ogrn_index — по ОГРН.
    
    o	token_to_keys — токены слов → ключи для быстрого поиска по частям названия.
    

9. Поиск организации по адресу
    
def find_org_for_address(raw_addr: str, addr_dict: dict, house_index: dict):

    ...
    
•	Использует несколько стратегий поиска:

    1.	Exact match — точное совпадение ключа.
    
    2.	Без токена "МО" (для Московской области).
    
    3.	По номеру дома с помощью house_index.
    
    4.	Убираем прилагательные ("Красногорский" → "").
    
•	Возвращает найденную организацию и метод поиска.


10. Поиск ИНН по организации
    
def find_inn_for_org(org: str, ogrn: str, ...):

    ...
    
•	Попытки найти ИНН:

    1.	По ОГРН.
    
    2.	Точное совпадение названия.
    
    3.	Совпадение по нормализованному названию.
    
    4.	Fuzzy match — по токенам с бонусом для "ТСЖ", "ЖСК", "УК".
    
•	Возвращает ИНН, короткое название, сайт, телефон, e-mail и способ нахождения.


11. Основной процесс
    
def main():

    ...
    
1)	Строит индекс адресов (build_addr_dict_from_csv).
   
2)	Строит индекс ИНН (build_inn_lookup).
   
3)	Читает входной файл с адресами.
   
4)	Для каждой строки:
   
      Нормализует адрес.
  	
      Находит УК.
  	
      Находит ИНН и контакты.
  	
      Сохраняет результаты в Excel.
  	
      Фиксирует пропущенные записи.
  	
6)	Выводит статистику обработки.


12. Запуск программы
    
if __name__ == "__main__":

    main()
    
•	Стандартная проверка: если файл запускается напрямую, вызывается функция main().

